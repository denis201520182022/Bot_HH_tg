# hr_bot/services/llm_handler.py

import os
import json
import logging
from openai import AsyncOpenAI
from dotenv import load_dotenv
import httpx

load_dotenv()
logger = logging.getLogger(__name__)

# –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–∫—Å–∏ –∏–∑ .env
SQUID_PROXY_HOST = os.getenv("SQUID_PROXY_HOST", "38.180.203.212")
SQUID_PROXY_PORT = os.getenv("SQUID_PROXY_PORT", "8787")
SQUID_PROXY_USER = os.getenv("SQUID_PROXY_USER", "zabota")
SQUID_PROXY_PASSWORD = os.getenv("SQUID_PROXY_PASSWORD", "zabota2000")

# –§–æ—Ä–º–∏—Ä—É–µ–º URL –ø—Ä–æ–∫—Å–∏ —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
proxy_url = (
    f"http://{SQUID_PROXY_USER}:{SQUID_PROXY_PASSWORD}@"
    f"{SQUID_PROXY_HOST}:{SQUID_PROXY_PORT}"
)

# –°–æ–∑–¥–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π HTTP –∫–ª–∏–µ–Ω—Ç —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø—Ä–æ–∫—Å–∏
async_http_client = httpx.AsyncClient(
    proxy=proxy_url,
    timeout=30.0
)

# –°–æ–∑–¥–∞–µ–º –ê–°–ò–ù–•–†–û–ù–ù–´–ô OpenAI –∫–ª–∏–µ–Ω—Ç –∏ –ø–µ—Ä–µ–¥–∞–µ–º –µ–º—É –Ω–∞—à HTTP –∫–ª–∏–µ–Ω—Ç
client = AsyncOpenAI(
    api_key=os.getenv("OPENAI_API_KEY"),
    http_client=async_http_client
)

logger.info(f"–ö–ª–∏–µ–Ω—Ç OpenAI –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ —Ä–∞–±–æ—Ç—É —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏: {SQUID_PROXY_HOST}:{SQUID_PROXY_PORT}")


# --- –ë–õ–û–ö –ò–ù–°–¢–†–£–ö–¶–ò–ô –î–õ–Ø OPENAI ---
JSON_FORMAT_INSTRUCTION = """
\n\n[CRITICAL RULE] –¢–≤–æ–π –æ—Ç–≤–µ—Ç –í–°–ï–ì–î–ê –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON.
–°—Ç—Ä—É–∫—Ç—É—Ä–∞ JSON –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å–ª–µ–¥—É—é—â–µ–π:
{
  "response_text": "–¢–≤–æ–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç—É –∫–∞–∫ —Ä–µ–∫—Ä—É—Ç–µ—Ä –ê–Ω–Ω–∞.",
  "new_state": "–Ω–æ–≤–æ–µ_—Å–æ—Å—Ç–æ—è–Ω–∏–µ_–¥–∏–∞–ª–æ–≥–∞",
  "extracted_data": { 
    "age": <—á–∏—Å–ª–æ –∏–ª–∏ null>, 
    "citizenship": "<—Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ null>", 
    "full_name": "<—Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ null>", 
    "city": "<—Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ null>",
    "readiness_to_start": "<—Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ null>" 
  }
}

[RULE] –í 'extracted_data' –ø–æ–º–µ—â–∞–π –¢–û–õ–¨–ö–û —Ç–µ –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –∫–∞–Ω–¥–∏–¥–∞—Ç —è–≤–Ω–æ —Å–æ–æ–±—â–∏–ª –≤ —Å–≤–æ–µ–º –ü–û–°–õ–ï–î–ù–ï–ú —Å–æ–æ–±—â–µ–Ω–∏–∏. –ù–µ –¥–æ–±–∞–≤–ª—è–π —Ç—É–¥–∞ –§–ò–û –∏–ª–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.
[RULE] –ï—Å–ª–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç –∑–∞–¥–∞–µ—Ç –≤–æ–ø—Ä–æ—Å, –ø—Ä–µ—Ä—ã–≤–∞—è —Ç–≤–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏, –æ—Ç–≤–µ—Ç—å –Ω–∞ –µ–≥–æ –≤–æ–ø—Ä–æ—Å, –∞ –∑–∞—Ç–µ–º –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –≤–µ—Ä–Ω–∏—Å—å –∫ —Ç–æ–º—É –≤–æ–ø—Ä–æ—Å—É, –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –∑–∞–¥–∞–≤–∞–ª–∞ –¥–æ —ç—Ç–æ–≥–æ, –∏ —Å–æ—Ö—Ä–∞–Ω–∏ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ('new_state').
[RULE] –ï—Å–ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ —Ç—ã –≤–∏–¥–∏—à—å —Ç–µ–∫—Å—Ç '[–§–ò–û –ó–ê–ú–ê–°–ö–ò–†–û–í–ê–ù–û]', —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –∫–∞–Ω–¥–∏–¥–∞—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª —Å–≤–æ–∏ –ø–æ–ª–Ω—ã–µ —Ñ–∞–º–∏–ª–∏—é, –∏–º—è –∏ –æ—Ç—á–µ—Å—Ç–≤–æ. –ù–µ –ø–µ—Ä–µ—Å–ø—Ä–∞—à–∏–≤–∞–π –∏—Ö, –∞ –ø–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏ –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É ‚Äî –∑–∞–ø—Ä–æ—Å—É –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞. –£—Å—Ç–∞–Ω–æ–≤–∏ 'new_state' –≤ 'awaiting_phone'.
[RULE] –ï—Å–ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ —Ç—ã –≤–∏–¥–∏—à—å —Ç–µ–∫—Å—Ç '[–¢–ï–õ–ï–§–û–ù –ó–ê–ú–ê–°–ö–ò–†–û–í–ê–ù]', —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –∫–∞–Ω–¥–∏–¥–∞—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª —Å–≤–æ–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞. –ù–µ –ø–µ—Ä–µ—Å–ø—Ä–∞—à–∏–≤–∞–π –µ–≥–æ, –∞ –ø–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏ –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É ‚Äî –∑–∞–ø—Ä–æ—Å—É –≥–æ—Ä–æ–¥–∞. –£—Å—Ç–∞–Ω–æ–≤–∏ 'new_state' –≤ 'awaiting_city'.

[IMPORTANT] –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —Å–ª–µ–¥—É—é—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—è 'new_state':
- 'awaiting_questions': –ï—Å–ª–∏ —Ç—ã –ø—Ä–µ–¥–ª–æ–∂–∏–ª–∞ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã.
- 'awaiting_age': –ï—Å–ª–∏ —Ç—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–ø—Ä–æ—Å–∏–ª–∞ –≤–æ–∑—Ä–∞—Å—Ç.
- 'awaiting_citizenship': –ï—Å–ª–∏ —Ç—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–ø—Ä–æ—Å–∏–ª–∞ –≥—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ.
- 'awaiting_readiness': –ï—Å–ª–∏ —Ç—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–ø—Ä–æ—Å–∏–ª–∞ –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ø—Ä–∏—Å—Ç—É–ø–∏—Ç—å –∫ —Ä–∞–±–æ—Ç–µ.
- 'awaiting_fio': –ï—Å–ª–∏ —Ç—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–ø—Ä–æ—Å–∏–ª–∞ –§–ò–û.
- 'awaiting_phone': –ï—Å–ª–∏ —Ç—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–ø—Ä–æ—Å–∏–ª–∞ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.
- 'awaiting_city': –ï—Å–ª–∏ —Ç—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–ø—Ä–æ—Å–∏–ª–∞ –≥–æ—Ä–æ–¥ –¥–ª—è —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è.
- 'qualification_failed': –ï—Å–ª–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç –Ω–µ –ø—Ä–æ—à–µ–ª –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—é –∏ —Ç—ã –µ–º—É –æ—Ç–∫–∞–∑—ã–≤–∞–µ—à—å.
- 'scheduling_spb_day': –ï—Å–ª–∏ —Ç—ã –Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–ø–∏—Å–∏ –≤ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–µ (—Å–ø—Ä–æ—Å–∏–ª–∞ –¥–µ–Ω—å).
- 'scheduling_spb_time': –ï—Å–ª–∏ —Ç—ã –∂–¥–µ—à—å –æ—Ç–≤–µ—Ç–∞ –ø—Ä–æ –≤—Ä–µ–º—è –≤ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–µ.
- 'interview_scheduled_spb': –ï—Å–ª–∏ —Ç—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–ª–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –≤ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–µ.
- 'forwarded_to_researcher': –ï—Å–ª–∏ —Ç—ã —Å–æ–æ–±—â–∏–ª–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç—É –æ –ø–µ—Ä–µ–¥–∞—á–µ –∑–∞—è–≤–∫–∏ —Ä–µ—Å—ë—á–µ—Ä–∞–º.
- 'dialogue_ongoing': –í–æ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö, –∫–æ–≥–¥–∞ –¥–∏–∞–ª–æ–≥ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –±–µ–∑ —Å–º–µ–Ω—ã –∫–ª—é—á–µ–≤–æ–≥–æ —ç—Ç–∞–ø–∞.
"""


async def get_bot_response(system_prompt: str, dialogue_history: list, user_message: str) -> dict:
    """
    –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ OpenAI —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏ –∏ –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç.
    """
    full_system_prompt = system_prompt + JSON_FORMAT_INSTRUCTION
    messages = [
        {"role": "system", "content": full_system_prompt},
    ]
    messages.extend(dialogue_history)
    messages.append({"role": "user", "content": user_message})

    try:
        logger.info(f"–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ LLM —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏...")
        
        response = await client.chat.completions.create(
            model="gpt-4-turbo",
            messages=messages,
            temperature=0.3,
            response_format={"type": "json_object"}
        )
        
        response_content = response.choices[0].message.content
        logger.info("–£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç LLM –ø–æ–ª—É—á–µ–Ω.")
        
        parsed_response = json.loads(response_content)
        return parsed_response

    except Exception as e:
        logger.critical(f"–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ OpenAI —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏: {e}", exc_info=True)
        return {
            "response_text": "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —É –º–µ–Ω—è –≤–æ–∑–Ω–∏–∫–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å AI-–º–æ–¥–µ–ª—å—é. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å –ø–æ–∑–∂–µ.",
            "new_state": "error_state",
            "extracted_data": None
        }


async def cleanup():
    """
    –ó–∞–∫—Ä—ã–≤–∞–µ—Ç HTTP –∫–ª–∏–µ–Ω—Ç –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
    –í—ã–∑–æ–≤–∏—Ç–µ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –≤ shutdown hook –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
    """
    await async_http_client.aclose()
    logger.info("üîí HTTP –∫–ª–∏–µ–Ω—Ç –∑–∞–∫—Ä—ã—Ç")